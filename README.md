# PTool种子下载助手

## 介绍

PT种子文件自动下载脚本，适用于M-Team。

兼容部分基于NexusPHP框架的站点（不同站点的兼容性无法保证，某些功能或特性可能无法使用）。

该脚本通过识别网页元素关键字，提取种子信息和下载链接，根据预设参数，定时模拟点击下载按钮，实现半自动化下载种子文件。

<img src="/img/beginPanel.png" width="15%"><img src="/img/logPanel.png" width="70%">



## 使用
* 使用Chrome/Edge等浏览器，安装[tampermonkey](https://www.tampermonkey.net/)扩展插件。
* 打开[该链接](https://raw.githubusercontent.com/AboutCXJ/PTool/main/PTool.js),复制脚本的所有内容。
* 在tampermonkey扩展中点击添加新脚本，粘贴内容，保存，并启用该脚本。
* 打开并登录站点，进入要下载的种子列表页面，将弹出Ptool种子下载助手控制面板。
* 设置配置参数，点击`开始`按钮，即可开始下载，等待下载任务完成，将自动停止。
* 点击`结束`按钮，或刷新整个页面，下载任务将提前终止。

## 配置

| 配置项         | 说明                                                      | 单位 | 取值范围    | 默认参数 |
| -------------- | --------------------------------------------------------- | ---- | ----------- | -------- |
| `种子数量`     | 要下载的种子个数                                          | 个   | [1-10000]   | 1000     |
| `最小种子`     | 限制种子的最小大小，将排除小于该数值的种子（0表示不限制） | MB   | [0-1048576] | 0        |
| `最大种子`     | 限制种子的最大大小，将排除大于该数值的种子（0表示不限制） | MB   | [0-1048576] | 0        |
| `翻页延时`     | 翻页与下载种子之间的间隔时间，预留时间用于页面刷新        | 秒   | [0-]        | 10       |
| `单种延时`     | 下载每1个种子之间的间隔时间，预留时间用于下载种子         | 秒   | [0-]        | 3        |
| `多种延时`     | 下载每100个种子之间的间隔时间，预留时间用于控制下载量     | 分钟 | [0-]        | 1        |
| `排除正在下载` | 排除正在下载的种子（下载中，未做种）                      | ——   | true/false  | true     |
| `排除正在做种` | 排除正在做种的种子（下载完成，正在做种）                  | ——   | true/false  | true     |
| `排除死种`     | 排除做种人数为0的种子                                     | ——   | true/false  | true     |
| `收藏模式`     | 仅收藏，不下载种子，配合QB的RSS订阅进行自动下载           | ——   | true/false  | false    |
| `模拟运行`     | 模拟运行脚本，实际上不下载种子                            | ——   | true/false  | false    |

### 推荐配置

**极速下载半自动推荐参数：**翻页延时：6-10秒，单种延时：2-3秒，多种延时：1分钟

**无人值守全自动推荐参数：**翻页延时：30秒，单种延时：30秒，多种延时：10分钟

**收藏模式全自动推荐参数：**翻页延时：60秒，单种延时：60秒，多种延时：0分钟。QB更新间隔：2分钟，QB请求延迟：3秒。

## 参与开发

* 在 _nexusPHPSites_ 添加站点
* 在 _torrentsPagePaths_ 添加路径
* 根据实际情况 设置 _selector_

``` js
    const nexusPHPSites = [
        "hdfans.org",
        ...
    ];

    // M-Team站点
    const mteamSites = [
        "m-team"
        ...
    ];

...

    // 种子页面路径
    const torrentsPagePaths = ["browse", "torrents.php"];

    // 配置选择器
    function loadSelector(currentURL) {
        if (mteamSites.some((site) => currentURL.includes(site))) {
            multiplePage = true;
            selector = {
                list: "tbody tr",
                title: "td:nth-child(3)",
                downloader: "td button",
                progressBar: "div[aria-valuenow='100']",
                size: "td div[class='mx-[-5px]']",
                seeders: "td span[aria-label*='arrow-up'] + span",
                leechers: "td span[aria-label*='arrow-down'] + span",
                nextPage: "li[title='下一頁'] button",
            };
        } ....
    }
```

## FAQs

**Q1：不显示插件界面？**

- 原因一：浏览器未开启开发人员模式，请输入chrome://extensions/或者edge://extensions/，进入扩展管理页面，打开`开发人员模式`选项。
- 原因二：站点地址不匹配，可能访问的站点不受支持，或者访问的不是种子列表页面。具体支持站点请直接查看源代码。



**Q2：运行了半天为什么没有下载？**

如果选中了“`模拟运行`”复选框，则插件处于模拟运行模式，但是实际上不会下载种子，真正下载时需要注意**不要选中该复选框**。

事实上，该选项有助于调试脚本相关配置参数。通过更改参数并观察执行效果，可以更好的匹配不同人员的下载需求。



**Q3：下载的种子数量与统计数量存在差异？**

如果网络质量不够好，下载某个种子时可能需要较长时间，如果在上一个种子未开始下载时就立即请求下载下一个种子，可能会导致上一个种子下载失败。

此时需要调整“`单种时延`”参数，保证每个种子开始下载之后再下载下一个种子。



**Q4：运行一段时间之后页面提示”请求过于频繁“？**

M-Team下载限制：**单个IP每小时100个（实测值：150个/小时）**，在1小时内访问超量时，将会提示上述信息。

此时需要调整”`多种时延`“参数，保证：单种时延` * 100 + `多种时延` > 1小时，确保每个小时的访问量不会超量。

另：可通过切换客户端IP地址来解除每小时的访问量限制，例如重新PPPOE拨号刷新动态IP，切换代理软件节点IP等方式。



**Q5：运行一段时间之后页面提示”本日下载额度用尽“？**

M-Team下载限制：**单个账号每天1000个（实测值：1500个/天）**，每日0点重置。无解。



**Q6：为什么有的站点只能下载一页？**

基于NexusPHP框架的站点在翻页时会刷新整个页面，会重新加载插件，导致下载任务被提前终止，因此只能下载1页的内容。

即使是基于NexusPHP框架的站点，不同站点的页面也会存在细小差异，选择器关键词可能会失效，导致脚本无法正常运行。

推荐使用[PT-Plugin-Plus](https://github.com/pt-plugins/PT-Plugin-Plus)浏览器插件下载基于NexusPHP框架的站点种子，可以瞬间下载页面的所有种子。



**Q7：为什么等了半天，只下载了几个文件？**

当页面处于非活动状态时，浏览器会减缓js脚本的执行频率，以降低对设备的性能消耗。

因此在执行本脚本时，请保持浏览器处于当前页面，请勿切换到其他页面或锁定计算机。



**Q8：收藏模式的工作机制？**

当选中“`收藏模式`”复选框之后，对于需要下载的种子，将会进行收藏，对于需要跳过的种子，将会取消收藏。

如果收藏夹内已有收藏的种子且需要保留，建议不要使用收藏模式。
